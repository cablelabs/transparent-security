# Copyright (c) 2019 Cable Television Laboratories, Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
- hosts: all

  gather_facts: no

  tasks:
    - name: install python-pip
      become: yes
      apt:
        update_cache: yes
        name:
          - python-pip
      register: apt_rc
      retries: 3
      delay: 10
      until: apt_rc is not failed

    - name: Copy local transparent-security source to remote {{ trans_sec_dir }} directory
      synchronize:
        # Top-level source directory relative to this directory
        src: ../../../
        dest: "{{ trans_sec_dir }}"
        dirs: yes
        rsync_opts:
          - "--exclude=.idea"
          - "--exclude=venv"
          - "--exclude=.git/objects/pack"
          - "--exclude=*/.terraform*"
          - "--exclude=*.tfstate"

    - name: install {{ trans_sec_dir }} and dependencies into python runtime
      command: sudo pip install -e {{ trans_sec_dir }}

    - name: Create ansible inventory file {{ remote_var_inventory | default('/home/ubuntu/variables.ini') }}
      file:
        path: "{{ remote_var_inventory | default('/home/ubuntu/variabels.ini') }}"
        state: touch

    - name: Create inventory variables heading at {{ remote_var_inventory }}
      lineinfile:
        path: "{{ remote_var_inventory | default('/home/ubuntu/variabels.ini') }}"
        line: "[all:vars]"
        state: present

    - name: Add variable entries to ansible inventory at {{ remote_var_inventory }}
      lineinfile:
        path: "{{ remote_var_inventory | default('/home/ubuntu/variabels.ini') }}"
        line: "{{ item }}"
        state: present
      loop:
        - "trans_sec_dir={{ src_dir | default('~/transparent-security') }}"
        - "srvc_log_dir={{ remote_srvc_log_dir | default('/var/log/transparent-security') }}"
        - "log_level={{ service_log_level | default('INFO') }}"
        - "remote_tps_dir={{ remote_tps_dir | default('/home/ubuntu/transparent-security') }}"
        - "remote_scripts_dir={{ remote_scripts_dir | default('/etc/transparent-security') }}"
        - "remote_ansible_inventory={{ remote_ansible_inventory | default('/home/ubuntu/transparent-security.ini') }}"
        - "topo_file={{ topo_file | default('mininet-sim-topology.yaml') }}"
        - "topo_file_loc=/etc/transparent-security/mininet-sim-topology.yaml"
        - "devices_conf_file={{ dev_daemon_file | default('/etc/transparent-security/device-daemons.yml') }}"
        - "sdn_ip={{ sdn_host | default('localhost') }}"
        - "sdn_port={{ sdn_port | default('9998') }}"
        - "ae_ip={{ sdn_host | default('localhost') }}"
        - "sdn_dev_intf={{ sdn_dev_intf | default('lo') }}"
        - "ae_dev_intf={{ ae_dev_intf | default('lo') }}"
        - "sdn_url=http://{{ sdn_host | default('localhost') }}:{{ sdn_port | default('9998') }}"
        - "clone_egress_port={{ clone_egress_port | default('3') }}"
