# TPS Siddhi AE

The Transparent Security Analytics Engine (TPS AE) is an analytics engine
implementation based on [Siddhi](https://siddhi.io/) event stream processing
(ESP) and complex event processing (CEP) framework. The Siddhi scripts
developed are able to identify a DDoS attack in less
than 1 second by examining telemetry reports generated by a switch or router.
This will also identify when a mitigated attack has ended based on drop
telemetry reports from the SDN controller.

The directions below are how to run this as a simple Java program (as with our
"lab_trial" scenario tests), but these scripts can also be deployed to any
Siddhi compliant engine containing our
[UDP](https://github.com/cablelabs/siddhi-io-udp) &
[P4-TRPT](https://github.com/cablelabs/siddhi-map-p4-trpt) extensions
(and a running Kafka instance). Additionally, Siddhi scripts can also be
converted to run in Kubernetes where the siddhi-operator has been installed.

## Host Software Requirements

1. Java 8+
1. git
1. maven
1. kafka

## Setup and run

There are several methods that can be used to run Siddhi scripts.

### Java application
The top-level Ansible playbook performing the actions listed below can be found
[here](../../playbooks/siddhi/setup_siddhi_maven.yml)

- Install Java 8+ - [playbook](../../playbooks/siddhi/setup_jdk.yml) (setting up OpenJDK 11.0.11)
- Install and start Kafka to port 9092 - [playbook](../../playbooks/siddhi/setup_kafka.yml)
  [installed based on these instructions](https://www.digitalocean.com/community/tutorials/how-to-install-apache-kafka-on-ubuntu-20-04)
- Install Siddhi for Maven - [playbook](../../playbooks/siddhi/setup_siddhi_p4.yml)
  - Install Git client (apt install git)
  - Install Maven client (apt install maven)
  - Clone the - [siddhi-map-p4-trpt](https://github.com/cablelabs/siddhi-map-p4-trpt.git) Git project

Execute following shell commands

```bash
cd {siddhi-map-p4-trpt directory}
mvn clean compile test
mvn exec:java -Dexec.mainClass=io.siddhi.extension.map.p4.StartSiddhiRuntime \
-Dexec.args="{siddhi-script-location} {siddhi-script-location} ..." -f pom.xml
```

### Kubernetes
Other than a Siddhi runtime server or Java application, another means to deploy
Siddhi scripts is on Kubernetes with the
[siddhi-operator](https://github.com/siddhi-io/siddhi-operator).

#### Setup
This Ansible [playbook](../../playbooks/siddhi/setup_siddhi_minikube.yml) is an
example of deploying the operators below onto a Minikube instance.

- Obtain access to a Kubernetes cluster
  For testing on a single machine, Please follow the instructions below:
  - Setup Docker - [playbook](../../playbooks/general/setup_docker.yml)
  - Setup Minikube - [playbook](../../playbooks/general/setup_minikube.yml)
    - Start Minikube - [playbook](../../playbooks/general/setup_siddhi_operator.yml)
    - Enable ingress addon (/usr/bin/minikube addons enable ingress)
- Install Kafka
```bash
kubectl create namespace kafka
kubectl create -f 'https://strimzi.io/install/latest?namespace=kafka' -n kafka
```
- Install siddhi-operator
```bash
kubectl apply -f https://github.com/siddhi-io/siddhi-operator/releases/download/v0.2.2/00-prereqs.yaml
kubectl apply -f https://github.com/siddhi-io/siddhi-operator/releases/download/v0.2.2/01-siddhi-operator.yaml
kubectl apply -f https://strimzi.io/examples/latest/kafka/kafka-persistent-single.yaml -n kafka
```

#### Deploy AE
To deploy the AE onto Kubernetes, please look at the following example
SiddhiProcess CRDs that can be simply deployed with the standard "kubectl apply -f"
command:
- [UDP to Telemetry Report JSON to Kafka](./kubernetes/trpt-to-kafka.yaml)
- [Telemetry Report JSON to DDoS Detect](./kubernetes/kafka-trpt-ddos-detection.yaml)
- [Telemetry Report JSON to Drop Clear Attack](./kubernetes/kafka-trpt-drop-clear.yaml)
